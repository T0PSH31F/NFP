<![CDATA[
<tool_usage_guide>
  <tool_priorities>
    <priority level="1">
      <tool>list_files</tool>
      <when>Always start by understanding the project structure</when>
      <why>Identifies flake organization, machine definitions, and module layout</why>
    </priority>
    <priority level="2">
      <tool>read_file</tool>
      <when>After identifying key files with list_files</when>
      <why>Gets full context of configurations, modules, and dependencies</why>
    </priority>
    <priority level="3">
      <tool>search_files</tool>
      <when>Looking for specific patterns or cross-referencing configurations</when>
      <why>Finds module imports, option usage, and potential conflicts</why>
    </priority>
  </tool_priorities>

  <tool_specific_guidance>
    <tool name="list_files">
      <best_practices>
        <practice>Always start with top-level structure to understand organization</practice>
        <practice>Check for machines/, modules/, and .sops.yaml files</practice>
        <practice>Look for multiple flake.nix files that might indicate conflicts</practice>
      </best_practices>
      <example scenario="Initial project analysis">
        <code>
list_files:
  path: .
  recursive: false
        </code>
        <output>
        .envrc
        clan.nix
        flake.lock
        flake.nix
        machines/
        modules/
        users/
        </output>
      </example>
    </tool>

    <tool name="read_file">
      <best_practices>
        <practice>Read flake.nix first to understand input structure</practice>
        <practice>Examine clan.nix for machine definitions</practice>
        <practice>Check machine configurations in machines/*/default.nix</practice>
      </best_practices>
      <example scenario="Analyzing flake structure">
        <code>
read_file:
  args:
    - path: flake.nix
    - path: clan.nix
    - path: machines/luffy/default.nix
        </code>
        <output>
        [File contents showing input definitions, clan inventory, and machine config]
        </output>
      </example>
    </tool>

    <tool name="search_files">
      <best_practices>
        <practice>Search for module imports to understand dependencies</practice>
        <practice>Look for option patterns like "clan.core.networking"</practice>
        <practice>Find potential conflicts with regex patterns</practice>
      </best_practices>
      <example scenario="Finding module conflicts">
        <code>
search_files:
  path: .
  regex: home-manager\.nixosModules
  file_pattern: *.nix
        </code>
        <output>
        flake.nix:19 - inputs.home-manager.nixosModules.home-manager
        modules/flake.nix:19 - home-manager.nixosModules.home-manager
        </output>
      </example>
    </tool>

    <tool name="ask_followup_question">
      <best_practices>
        <practice>Ask about deployment targets when clan-core networking is missing</practice>
        <practice>Clarify omarchy-nix configuration preferences</practice>
        <practice>Ask about secrets management requirements</practice>
      </best_practices>
      <example scenario="Missing deployment configuration">
        <ask_followup_question>
          <question>What is the target deployment host for the luffy machine?</question>
          <follow_up>
            <suggest>root@192.168.8.212 (current static IP)</suggest>
            <suggest>luffy.local (hostname resolution)</suggest>
            <suggest>dynamic IP (needs discovery)</suggest>
            <suggest>Not deploying with clan-cli</suggest>
          </follow_up>
        </ask_followup_question>
      </example>
    </tool>

    <tool name="nixos_search">
      <best_practices>
        <practice>Search for NixOS options when validating configurations</practice>
        <practice>Check omarchy-nix availability and options</practice>
        <practice>Find sops-nix configuration patterns</practice>
      </best_practices>
      <example scenario="Validating omarchy-nix options">
        <code>
nixos_search:
  query: "omarchy enable theme"
  search_type: "options"
  limit: 10
        </code>
        <output>
        programs.omarchy.enable - Enable omarchy
        programs.omarchy.theme - Theme for omarchy
        [...]
        </output>
      </example>
    </tool>
  </tool_specific_guidance>

  <configuration_validation>
    <step>Validate flake inputs follow proper patterns</step>
    <step>Check clan-core machine definitions exist</step>
    <step>Verify module imports don't conflict</step>
    <step>Test secrets management setup</step>
    <step>Confirm omarchy-nix integration</step>
  </configuration_validation>
</tool_usage_guide>
]]>