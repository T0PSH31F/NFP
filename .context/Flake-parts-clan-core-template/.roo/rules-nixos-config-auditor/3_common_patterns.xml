<![CDATA[
<common_patterns>
  <flake_patterns>
    <pattern name="clan-core-flake">
      <description>Standard clan-core flake with flake-parts integration</description>
      <code language="nix">
{
  inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
  inputs.clan-core.inputs.nixpkgs.follows = "nixpkgs";
  
  inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";
  
  inputs.flake-parts.url = "github:hercules-ci/flake-parts";
  inputs.flake-parts.inputs.nixpkgs-lib.follows = "nixpkgs";
  inputs.flake-parts.inputs.nixpkgs.follows = "nixpkgs";

  inputs.omarchy-nix = {
    url = "github:henrysipp/omarchy-nix";
    inputs.nixpkgs.follows = "nixpkgs";
    inputs.home-manager.follows = "home-manager";
  };

  inputs.sops-nix = {
    url = "github:Mic92/sops-nix";
    inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs = inputs @ { flake-parts, ... }:
    flake-parts.lib.mkFlake { inherit inputs; } {
      systems = [ "x86_64-linux" "aarch64-linux" ];
      
      imports = [ inputs.clan-core.flakeModules.default ];

      clan = {
        imports = [ ./clan.nix ];
      };

      perSystem = { pkgs, inputs', ... }: {
        devShells.default = pkgs.mkShell {
          packages = [
            inputs'.clan-core.packages.clan-cli
            pkgs.sops
            pkgs.age
          ];
        };
      };
    };
}
      </code>
    </pattern>

    <pattern name="clan-inventory">
      <description>Clan inventory with machine definitions and services</description>
      <code language="nix">
{
  meta.name = "my-clan";
  meta.tld = "mylab";

  inventory.machines = {
    luffy = {
      clan.core.networking.targetHost = "root@192.168.8.212";
    };
  };

  inventory.instances = {
    admin = {
      roles.default.tags.all = { };
      roles.default.settings.allowedKeys = {
        "admin-key" = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...";
      };
    };

    zerotier = {
      roles.controller.machines."luffy" = { };
      roles.peer.tags.all = { };
    };

    tor = {
      roles.server.tags.nixos = { };
    };
  };

  machines = {
    luffy = { config, pkgs, ... }: {
      imports = [ ./machines/luffy/default.nix ];

      # Additional clan-specific configuration
    };
  };
}
      </code>
    </pattern>
  </flake_patterns>

  <module_patterns>
    <pattern name="omarchy-integration">
      <description>Integrate omarchy-nix with clan-core and home-manager</description>
      <code language="nix">
{ config, pkgs, lib, ... }:
with lib;

{
  imports = [
    inputs.omarchy-nix.nixosModules.default
    inputs.home-manager.nixosModules.home-manager
  ];

  config = {
    # Enable home-manager globally
    home-manager.useGlobalPkgs = true;

    # Basic system configuration
    networking.hostName = "luffy";
    
    # Omarchy configuration
    omarchy = {
      enable = true;
      full_name = "Erik Wright";
      email_address = "wrighterik77@gmail.com";
      theme = "tokyo-night";
      primary_font = "Berkeley Mono";
    };

    # User configuration
    users.users.t0psh31f = {
      isNormalUser = true;
      hashedPassword = "$6$...";
      extraGroups = [ "wheel" "networkmanager" ];
    };

    home-manager.users.t0psh31f = {
      imports = [ inputs.omarchy-nix.homeManagerModules.default ];

      # Home-manager specific configuration
      programs.home-manager.enable = true;
    };
  };
}
      </code>
    </pattern>

    <pattern name="sops-secrets">
      <description>Sops-nix secrets configuration</description>
      <code language="nix">
{ config, lib, ... }:
with lib;

{
  sops = {
    age = "age1recipientkey";
    defaultSopsFile = ./secrets/secrets.yaml;
    
    # Per-application secrets
    apps."myapp" = {
      file = ./secrets/myapp.yaml;
      prefix = "myapp.";
    };
  };

  services.postgresql = {
    enable = true;
    initialScript = sops.secrets."postgres-init.sql";
  };

  services.redis = {
    enable = true;
    settings = {
      requirepass = sops.secrets.redis_password;
    };
  };
}
      </code>
    </pattern>
  </module_patterns>

  <troubleshooting_patterns>
    <pattern name="fix-version-conflicts">
      <description>Resolve nixpkgs version conflicts</description>
      <code language="nix">
# Before (problematic)
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";

# After (corrected)
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.clan-core.inputs.nixpkgs.follows = "nixpkgs";
inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";
      </code>
    </pattern>

    <pattern name="fix-missing-machine">
      <description>Add missing machine to clan inventory</description>
      <code language="nix">
# Add to clan.nix inventory.machines
inventory.machines = {
  luffy = {
    clan.core.networking.targetHost = "root@hostname-or-ip";
  };
};

# Add to clan.nix machines
machines = {
  luffy = { config, pkgs, ... }: {
    imports = [ ./machines/luffy/default.nix ];
    # Additional configuration
  };
};
      </code>
    </pattern>
  </troubleshooting_patterns>
</common_patterns>
]]>