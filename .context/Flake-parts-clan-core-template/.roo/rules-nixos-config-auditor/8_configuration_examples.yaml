# Enhanced NixOS Configuration Examples
# This file provides complete working examples of the fixed configurations

## FIXED FLAKE.NIX
fixed_flake_nix: |
  {
    inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
    inputs.clan-core.inputs.nixpkgs.follows = "nixpkgs";
    
    inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";
    
    inputs.flake-parts.url = "github:hercules-ci/flake-parts";
    inputs.flake-parts.inputs.nixpkgs-lib.follows = "nixpkgs";
    inputs.flake-parts.inputs.nixpkgs.follows = "nixpkgs";

    inputs.omarchy-nix = {
      url = "github:henrysipp/omarchy-nix";
      inputs.nixpkgs.follows = "nixpkgs";
      inputs.home-manager.follows = "home-manager";
    };

    inputs.sops-nix = {
      url = "github:Mic92/sops-nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    outputs = inputs @ { flake-parts, ... }:
      flake-parts.lib.mkFlake { inherit inputs; } {
        systems = [ "x86_64-linux" "aarch64-linux" ];
        
        imports = [ inputs.clan-core.flakeModules.default ];

        clan = {
          imports = [ ./clan.nix ];
        };

        perSystem = { pkgs, inputs', ... }: {
          devShells.default = pkgs.mkShell {
            packages = [
              inputs'.clan-core.packages.clan-cli
              pkgs.sops
              pkgs.age
              pkgs.nixos-rebuild
            ];
          };
        };
      };
  }

## UPDATED CLAN.NIX
updated_clan_nix: |
  {
    meta.name = "my-clan";
    meta.tld = "mylab";

    inventory.machines = {
      luffy = {
        clan.core.networking.targetHost = "root@192.168.8.212";
      };
    };

    inventory.instances = {
      admin = {
        roles.default.tags.all = { };
        roles.default.settings.allowedKeys = {
          "admin-key" = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...";
        };
      };

      zerotier = {
        roles.controller.machines."luffy" = { };
        roles.peer.tags.all = { };
      };

      tor = {
        roles.server.tags.nixos = { };
      };
    };

    machines = {
      luffy = { config, pkgs, ... }: {
        imports = [ ./machines/luffy/default.nix ];

        # Additional clan-specific configuration
        networking.hostName = "luffy";
      };
    };
  }

## FIXED LUFFY MACHINE CONFIG
fixed_luffy_config: |
  { config, lib, pkgs, ... }:

  {
    imports = [
      ./hardware-configuration.nix
    ];

    nix.settings.experimental-features = [ "nix-command" "flakes" ];
    boot.loader.systemd-boot.enable = true;
    boot.loader.efi.canTouchEfiVariables = true;

    boot.kernelPackages = pkgs.linuxPackages_latest;

    # FIXED: Correct LUKS device UUID matching hardware-configuration.nix
    boot.initrd.luks.devices."luks-2b036757-4971-48bd-af7d-247bcc51d1d4".device = "/dev/disk/by-uuid/2b036757-4971-48bd-af7d-247bcc51d1d4";
    
    networking.hostName = "luffy";
    networking.networkmanager.enable = true;
    time.timeZone = "America/Los_Angeles";
    i18n.defaultLocale = "en_US.UTF-8";

    # FIXED: Add clan modules import
    clan.core.networking.targetHost = "root@192.168.8.212";
    
    users.users.t0psh31f = {
      isNormalUser = true;
      hashedPassword = "$6$rcE5fxWVkSf/5v/w$CTV8V85IPFB5cGW2B2rsxxeccNf.KUiHDaoDH1WMoNvW1j/NqzbEaOD27Jj2SpA3wUbAGsThn2VhsjoR6YdOE/";
      description = "t0psh31f";
      extraGroups = [ "wheel" "networkmanager" ];
    };

    nixpkgs.config.allowUnfree = true;

    environment.systemPackages = with pkgs; [
      neovim
      wget
      curl
      lsd
      gedit
      git
    ];

    services.pipewire = {
      enable = true;
      alsa.enable = true;
      alsa.support32Bit = true;
      pulse.enable = true;
    };

    services.openssh = {
      enable = true;
      settings = {
        PasswordAuthentication = false;
        PermitRootLogin = "prohibit-password";
      };
    };

    networking.firewall.allowedTCPPorts = [ 22 2222 ];
    networking.firewall.allowedUDPPorts = [ 22 ];

    system.stateVersion = "25.05";
  }

## ENHANCED USER CONFIGURATION WITH OMARCHY
enhanced_user_config: |
  { config, pkgs, lib, ... }:

  {
    nixpkgs.config.allowUnfreePredicate = pkg: builtins.elem (lib.getName pkg) [
      "vscode"
    ];

    home.username = "t0psh31f";
    home.homeDirectory = "/home/t0psh31f";
    home.stateVersion = "25.05";
    programs.home-manager.enable = true;

    # FIXED: Integrate omarchy-nix
    programs.omarchy = {
      enable = true;
      full_name = "Erik Wright";
      email_address = "wrighterik77@gmail.com";
      theme = "tokyo-night";
      primary_font = "Berkeley Mono";
      quick_app_bindings = [
        "SUPER, A, exec, $webapp=https://claude.ai"
        "SUPER, E, exec, $webapp=https://app.hey.com"
        "SUPER, F, exec, $fileManager"
        "SUPER, T, exec, $terminal -e btop"
      ];
    };

    programs.git.extraConfig.credential.helper = "store";
    programs.ssh.enable = true;
  }

## SOPS SECRETS CONFIGURATION
sops_configuration: |
  # .sops.yaml
  keys:
    - &admin_user age104f5g5347tmcx3kdpz4np4m3040j94wahexgazp7xvz553qhfu7st6pqss

  creation_rules:
    - path_regex: secrets/[^/]+\.(yaml|json|env|ini)$
      key_groups:
        - age:
          - *admin_user

## OMARCHY APPLICATION BINDINGS EXAMPLE
omarchy_bindings_example: |
  programs.omarchy = {
    enable = true;
    full_name = "Erik Wright";
    email_address = "wrighterik77@gmail.com";
    theme = "tokyo-night";
    primary_font = "Berkeley Mono";
    
    # Application shortcuts
    quick_app_bindings = [
      "SUPER, A, exec, $webapp=https://claude.ai"
      "SUPER, C, exec, $webapp=https://app.hey.com/calendar/weeks/"
      "SUPER, E, exec, $webapp=https://app.hey.com"
      "SUPER, F, exec, $fileManager"
      "SUPER, T, exec, $terminal"
      "SUPER, V, exec, $terminal -e nvim"
      "SUPER, M, exec, $music"
    ];
    
    # VSCode settings
    vscode_settings = {
      "editor.fontFamily" = "Berkeley Mono";
      "editor.minimap.enabled" = false;
      "vim.useCtrlKeys" = false;
    };
  };

## DEVELOPMENT SHELL ENHANCEMENTS
devshell_enhancements: |
  perSystem = { pkgs, inputs', ... }: {
    devShells.default = pkgs.mkShell {
      packages = [
        # Clan-core tools
        inputs'.clan-core.packages.clan-cli
        pkgs.nixos-rebuild
        
        # Secrets management
        pkgs.sops
        pkgs.age
        
        # Development tools
        pkgs.git
        pkgs.curl
        pkgs.wget
        pkgs.neovim
        
        # Omarchy development
        pkgs.nodejs
        pkgs.yarn
      ];
      
      # Environment variables for development
      OMARCHY_DEV = "1";
      EDITOR = "nvim";
    };
  };

## TESTING COMMANDS
testing_commands: |
  # Validate flake structure
  nix flake check
  
  # Test configuration build
  nixos-rebuild build --flake .#luffy
  
  # Check clan configuration
  clan machines list
  
  # Test secrets access
  sops -d secrets/secrets.yaml
  
  # Validate omarchy configuration
  nix eval .#nixosConfigurations.luffy.config.omarchy
  
  # Dry run deployment
  clan deploy --dry-run luffy