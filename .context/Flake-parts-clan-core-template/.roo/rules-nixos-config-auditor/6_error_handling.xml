<![CDATA[
<error_handling>
  <common_errors>
    <error name="flake-input-conflicts">
      <description>Version conflicts between different nixpkgs sources</description>
      <symptoms>
        <symptom>Build failures with "infinite recursion" errors</symptom>
        <symptom>Different package versions in closure</symptom>
        <symptom>flake.lock showing multiple nixpkgs versions</symptom>
      </symptoms>
      <root_cause>Missing or incorrect 'follows' statements in flake inputs</root_cause>
      <resolution>
        <step>Add proper follows statements for all inputs</step>
        <step>Ensure clan-core follows main nixpkgs input</step>
        <step>Use consistent version pinning across all inputs</step>
      </resolution>
      <example>
        <before>
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";
        </before>
        <after>
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.clan-core.inputs.nixpkgs.follows = "nixpkgs";
inputs.nixpkgs.url = "github:nixos/nixpkgs/nixos-25.05";
        </after>
      </example>
    </error>

    <error name="missing-machine-definition">
      <description>Clan-core cannot manage machine due to missing inventory entry</description>
      <symptoms>
        <symptom>clan machines list shows no machines</symptom>
        <symptom>clan deploy fails with "machine not found" error</symptom>
        <symptom>ClanInternals output missing machine configuration</symptom>
      </symptoms>
      <root_cause>Machine not defined in clan.inventory.machines or clan.machines</root_cause>
      <resolution>
        <step>Add machine to clan.inventory.machines with networking config</step>
        <step>Add machine to clan.machines with module imports</step>
        <step>Verify targetHost is reachable and properly formatted</step>
      </resolution>
      <example>
        <before>
inventory.machines = { };
machines = { };
        </before>
        <after>
inventory.machines = {
  luffy = {
    clan.core.networking.targetHost = "root@192.168.8.212";
  };
};
machines = {
  luffy = { config, pkgs, ... }: {
    imports = [ ./machines/luffy/default.nix ];
  };
};
        </after>
      </example>
    </error>

    <error name="secrets-decryption-failed">
      <description>Sops-nix cannot decrypt secrets</description>
      <symptoms>
        <symptom>Build error: "Failed to decrypt file"</symptom>
        <symptom>Missing age keys or incorrect recipients</symptom>
        <symptom>Sops configuration not found</symptom>
      </symptoms>
      <root_cause>Missing or incorrect age keys, wrong .sops.yaml configuration</root_cause>
      <resolution>
        <step>Verify age keys are available in ~/.config/sops/age/keys.txt</step>
        <step>Check .sops.yaml has correct recipient keys</step>
        <step>Ensure secrets files are properly encrypted with sops</step>
        <step>Test decryption: sops -d secrets/example.yaml</step>
      </resolution>
      <example>
        <before>
# Missing .sops.yaml or incorrect keys
        </before>
        <after>
# .sops.yaml
keys:
  - &admin_user age1recipientkey...

creation_rules:
  - path_regex: secrets/[^/]+\.(yaml|json)$
    key_groups:
      - age:
        - *admin_user
        </after>
      </example>
    </error>

    <error name="omarchy-module-conflict">
      <description>Conflicting omarchy-nix or home-manager configurations</description>
      <symptoms>
        <symptom>Build error: "The option value is not of type..."</symptom>
        <symptom>Multiple home-manager instances detected</symptom>
        <symptom>Module import conflicts</symptom>
      </symptoms>
      <root_cause>Duplicate or conflicting module imports between different flakes</root_cause>
      <resolution>
        <step>Consolidate all omarchy-nix configuration into main flake</step>
        <step>Remove duplicate home-manager imports</step>
        <step>Use either clan-core integration or separate flake, not both</step>
      </resolution>
      <example>
        <before>
# Separate flake with omarchy-nix
# Multiple home-manager configurations
        </before>
        <after>
# Single flake with consolidated omarchy-nix
inputs.omarchy-nix = {
  url = "github:henrysipp/omarchy-nix";
  inputs.nixpkgs.follows = "nixpkgs";
  inputs.home-manager.follows = "home-manager";
};
# Use clan-core's home-manager integration
        </after>
      </example>
    </error>

    <error name="luks-device-mismatch">
      <description>LUKS device UUID doesn't match hardware configuration</description>
      <symptoms>
        <symptom>Boot failure: "Cannot find LUKS device"</symptom>
        <symptom>Hardware scan shows different UUIDs</symptom>
        <symptom>systemd-cryptsetup service fails</symptom>
      </symptoms>
      <root_cause>Manual configuration has wrong UUID or doesn't match generated hardware config</root_cause>
      <resolution>
        <step>Compare UUIDs in hardware-configuration.nix and default.nix</step>
        <step>Update manual configuration to match hardware scan</step>
        <step>Re-run nixos-generate-config if needed</step>
      </resolution>
      <example>
        <before>
boot.initrd.luks.devices."luks-e66c6fd1-b2f2-469c-8af8-b0e4a46a3644".device = "/dev/disk/by-uuid/e66c6fd1-b2f2-469c-8af8-b0e4a46a3644";
        </before>
        <after>
# Match UUID from hardware-configuration.nix
boot.initrd.luks.devices."luks-2b036757-4971-48bd-af7d-247bcc51d1d4".device = "/dev/disk/by-uuid/2b036757-4971-48bd-af7d-247bcc51d1d4";
        </after>
      </example>
    </error>
  </common_errors>

  <validation_steps>
    <step>Run nix flake check to validate flake structure</step>
    <step>Test configuration build: nixos-rebuild build --flake .#luffy</step>
    <step>Check clan configuration: clan machines list</step>
    <step>Verify secrets access: sops -d secrets/example.yaml</step>
    <step>Test deployment readiness: clan deploy --dry-run luffy</step>
  </validation_steps>

  <emergency_procedures>
    <procedure name="rollback-configuration">
      <description>Quick rollback if deployment fails</description>
      <steps>
        <step>Identify working previous generation: nix-env-list --profile /nix/var/nix/profiles/system</step>
        <step>Rollback: nixos-rebuild switch --profile /nix/var/nix/profiles/system --generation N</step>
        <step>Investigate failure and fix configuration</step>
        <step>Test fixes before redeploying</step>
      </steps>
    </procedure>

    <procedure name="secrets-emergency-access">
      <description>Access secrets when sops fails</description>
      <steps>
        <step>Check age key availability: cat ~/.config/sops/age/keys.txt</step>
        <step>Fallback to manual decryption if needed</step>
        <step>Regenerate sops configuration if corrupted</step>
        <step>Update .sops.yaml and re-encrypt secrets</step>
      </steps>
    </procedure>
  </emergency_procedures>
</error_handling>
]]>