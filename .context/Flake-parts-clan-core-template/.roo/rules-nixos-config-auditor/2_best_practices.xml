<![CDATA[
<best_practices>
  <general_principles>
    <principle priority="high">
      <name>Flake Input Management</name>
      <description>Properly manage flake inputs with consistent version pinning</description>
      <rationale>Ensures reproducible builds and prevents dependency conflicts</rationale>
      <example>
        <scenario>Adding new inputs to a flake</scenario>
        <good>
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.clan-core.inputs.nixpkgs.follows = "nixpkgs";
inputs.omarchy-nix = {
  url = "github:henrysipp/omarchy-nix";
  inputs.nixpkgs.follows = "nixpkgs";
  inputs.home-manager.follows = "home-manager";
};
        </good>
        <bad>
inputs.clan-core.url = "https://git.clan.lol/clan/clan-core/archive/main.tar.gz";
inputs.omarchy-nix.url = "github:henrysipp/omarchy-nix";
        </bad>
      </example>
    </principle>

    <principle priority="high">
      <name>Secrets Management</name>
      <description>Always use sops-nix for secrets, never commit plaintext</description>
      <rationale>Protects sensitive information and follows security best practices</rationale>
      <example>
        <scenario>Configuring secrets in NixOS</scenario>
        <good>
sops = {
  age = "age1examplekey";
  defaultSopsFile = ./secrets/config.yaml;
};
services.postgresql.initialScript = sops.secrets."postgres-init.sql";
        </good>
        <bad>
services.postgresql.initialScript = "/path/to/unencrypted/script.sql";
        </bad>
      </example>
    </principle>

    <principle priority="medium">
      <name>Module Organization</name>
      <description>Keep modules focused and well-organized</description>
      <rationale>Improves maintainability and reusability</rationale>
      <example>
        <scenario>Organizing configuration modules</scenario>
        <good>
modules = [
  ./modules/base.nix
  ./modules/networking.nix
  ./modules/users.nix
  inputs.omarchy.nixosModules.default
];
        </good>
        <bad>
# All configuration in one massive file
{ config, pkgs, ... }: {
  # 500+ lines of mixed concerns
}
        </bad>
      </example>
    </principle>
  </general_principles>

  <code_conventions>
    <convention category="naming">
      <rule>Use kebab-case for file names and snake_case for NixOS options</rule>
      <examples>
        <good>machines/luffy/default.nix, omarchy_config</good>
        <bad>machines/Luffy/Default.nix, omarchyConfig</bad>
      </examples>
    </convention>
    
    <convention category="structure">
      <rule>Follow the NixOS module pattern with clear imports and configuration</rule>
      <template>
{ config, pkgs, lib, ... }:
with lib;
{
  imports = [ /* module imports */ ];

  config = {
    # Configuration here
  };
}
      </template>
    </convention>
  </code_conventions>

  <common_pitfalls>
    <pitfall>
      <description>Version conflicts between different nixpkgs sources</description>
      <why_problematic>Can cause build failures and inconsistent environments</why_problematic>
      <correct_approach>Use follows consistently and pin to stable versions</correct_approach>
    </pitfall>

    <pitfall>
      <description>Missing clan-core machine definitions</description>
      <why_problematic>Prevents clan-cli from managing machines properly</why_problematic>
      <correct_approach>Add machines to clan.inventory.machines with proper networking config</correct_approach>
    </pitfall>

    <pitfall>
      <description>Conflicting home-manager configurations</description>
      <why_problematic>Multiple home-manager instances can interfere with each other</why_problematic>
      <correct_approach>Use clan-core's home-manager integration or separate flake, not both</correct_approach>
    </pitfall>
  </common_pitfalls>

  <quality_checklist>
    <category name="before_starting">
      <item>Verify all flake inputs are properly pinned</item>
      <item>Check clan-core machine definitions exist</item>
      <item>Ensure secrets are properly encrypted with sops-nix</item>
    </category>
    <category name="during_implementation">
      <item>Test configuration with nix flake check</item>
      <item>Validate module imports don't conflict</item>
      <item>Verify omarchy-nix integration is compatible</item>
    </category>
    <category name="before_completion">
      <item>Ensure no plaintext secrets in configuration</item>
      <item>Test deployment with clan-cli</item>
      <item>Validate home-manager configuration</item>
    </category>
  </quality_checklist>
</best_practices>
]]>